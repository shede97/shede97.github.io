<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>World Happiness 2024 Narrative Visualization</title>
    <script src="https://d3js.org/d3.v4.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .container { margin: 20px auto; max-width: 800px; }
        .controls { margin-bottom: 20px; }
        .button { padding: 10px 20px; margin: 5px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
        .button:hover { background-color: #0056b3; }
        .tooltip { position: absolute; background-color: white; border: 1px solid black; padding: 5px; pointer-events: none; }
        .regression-line { stroke: red; stroke-width: 2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Exploring 2024 World Happiness Factors</h1>
        <p id="data-context">Data from the 2024 World Happiness Report, a global survey recognized by governments and organizations, assesses happiness through expert analysis in economics, psychology, and public policy. The dataset includes 140 countries with metrics like Ladder score (0-10 happiness scale), Social support, Healthy life expectancy, and Freedom to make life choices. Linear regression analysis shows Social support (R² = [SS_R2]), Healthy life expectancy (R² = [HLE_R2]), and Freedom to make life choices (R² = [FMC_R2]) correlate with Ladder score, with [strongest_factor] showing the strongest correlation.</p>
        <div class="controls">
            <button class="button" onclick="updateScene(1, data)">Scene 1: Social Support</button>
            <button class="button" onclick="updateScene(2, data)">Scene 2: Life Expectancy</button>
            <button class="button" onclick="updateScene(3, data)">Scene 3: Freedom</button>
        </div>
        <svg id="visualization" width="900" height="500"></svg>
    </div>
    <script>
        // Linear regression and R² calculation
        function linearRegression(data, xKey, yKey) {
            const n = data.length;
            const xSum = d3.sum(data, d => d[xKey]);
            const ySum = d3.sum(data, d => d[yKey]);
            const xySum = d3.sum(data, d => d[xKey] * d[yKey]);
            const x2Sum = d3.sum(data, d => d[xKey] * d[xKey]);

            const slope = (n * xySum - xSum * ySum) / (n * x2Sum - xSum * xSum);
            const intercept = (ySum - slope * xSum) / n;

            const yMean = ySum / n;
            const ssTot = d3.sum(data, d => Math.pow(d[yKey] - yMean, 2));
            const ssRes = d3.sum(data, d => Math.pow(d[yKey] - (slope * d[xKey] + intercept), 2));
            const r2 = 1 - (ssRes / ssTot);

            return { slope, intercept, r2 };
        }

        // Parameters
        const scenes = {
            1: { x: "Social support", y: "Ladder score", title: "Happiness vs Social Support" },
            2: { x: "Healthy life expectancy", y: "Ladder score", title: "Happiness vs Healthy Life Expectancy" },
            3: { x: "Freedom to make life choices", y: "Ladder score", title: "Happiness vs Freedom", interactive: true }
        };

        // SVG setup
        const svg = d3.select("#visualization");
        const margin = { top: 50, right: 50, bottom: 70, left: 70 };
        const width = svg.attr("width") - margin.left - margin.right;
        const height = svg.attr("height") - margin.top - margin.bottom;
        const g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Scales
        const xScale = d3.scaleLinear().range([0, width]);
        const yScale = d3.scaleLinear().range([height, 0]);
        const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

        // Axes
        const xAxis = g.append("g").attr("transform", "translate(0," + height + ")");
        const yAxis = g.append("g");

        // Tooltip
        const tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

        // Update scene function (global scope)
        function updateScene(sceneNumber, data) {
            const scene = scenes[sceneNumber];

            // Clear previous content
            g.selectAll(".dot, .regression-line").remove();

            // Update scales
            xScale.domain(d3.extent(data, d => d[scene.x]) || [0, 1]).nice();
            yScale.domain(d3.extent(data, d => d[scene.y]) || [0, 1]).nice();

            // Update axes
            xAxis.transition().call(d3.axisBottom(xScale));
            yAxis.transition().call(d3.axisLeft(yScale));
            xAxis.selectAll("text").remove();
            xAxis.append("text")
                .attr("x", width / 2)
                .attr("y", 40)
                .attr("fill", "black")
                .text(scene.x);
            yAxis.selectAll("text").remove();
            yAxis.append("text")
                .attr("x", -height / 2)
                .attr("y", -40)
                .attr("transform", "rotate(-90)")
                .attr("fill", "black")
                .text(scene.y);

            // Title
            svg.selectAll(".title").remove();
            svg.append("text")
                .attr("class", "title")
                .attr("x", width / 2 + margin.left)
                .attr("y", margin.top / 2)
                .attr("text-anchor", "middle")
                .text(scene.title);

            // Draw dots
            g.selectAll(".dot")
                .data(data)
                .enter()
                .append("circle")
                .attr("class", "dot")
                .attr("cx", d => xScale(d[scene.x]))
                .attr("cy", d => yScale(d[scene.y]))
                .attr("r", 5)
                .attr("fill", (d, i) => colorScale(i % 10))
                .on("mouseover", function(d) {
                    tooltip.transition().style("opacity", 0.9);
                    tooltip.html(`Country: ${d["Country name"]}<br>Ladder score: ${d["Ladder score"]}<br>${scene.x}: ${d[scene.x]}`)
                        .style("left", (d3.event.pageX + 5) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.transition().style("opacity", 0);
                });

            // Draw regression line for Scenes 1 and 2
            if (sceneNumber === 1 || sceneNumber === 2) {
                const regression = linearRegression(data, scene.x, scene.y);
                const xMin = xScale.domain()[0];
                const xMax = xScale.domain()[1];
                const yMin = regression.slope * xMin + regression.intercept;
                const yMax = regression.slope * xMax + regression.intercept;

                g.append("line")
                    .attr("class", "regression-line")
                    .attr("x1", xScale(xMin))
                    .attr("y1", yScale(yMin))
                    .attr("x2", xScale(xMax))
                    .attr("y2", yScale(yMax));
            }
        }

        // Load data and initialize
        let data = [];
        d3.csv("world-happiness-report-2024.csv", function(error, csvData) {
            if (error) {
                console.error("Error loading CSV:", error);
                return;
            }

            // Convert strings to numbers and filter out invalid rows
            data = csvData.filter(d => 
                d["Ladder score"] && 
                d["Social support"] && 
                d["Healthy life expectancy"] && 
                d["Freedom to make life choices"] &&
                !isNaN(+d["Ladder score"]) &&
                !isNaN(+d["Social support"]) &&
                !isNaN(+d["Healthy life expectancy"]) &&
                !isNaN(+d["Freedom to make life choices"])
            ).map(d => ({
                "Country name": d["Country name"],
                "Ladder score": +d["Ladder score"],
                "Social support": +d["Social support"],
                "Healthy life expectancy": +d["Healthy life expectancy"],
                "Freedom to make life choices": +d["Freedom to make life choices"]
            }));

            console.log("Processed data:", data);

            // Calculate R² values for all scenes
            const ssRegression = linearRegression(data, "Social support", "Ladder score");
            const hleRegression = linearRegression(data, "Healthy life expectancy", "Ladder score");
            const fmcRegression = linearRegression(data, "Freedom to make life choices", "Ladder score");
            const r2Values = {
                ss: ssRegression.r2.toFixed(3),
                hle: hleRegression.r2.toFixed(3),
                fmc: fmcRegression.r2.toFixed(3)
            };
            const strongestFactor = Math.max(ssRegression.r2, hleRegression.r2, fmcRegression.r2) === ssRegression.r2 ? "Social support" :
                                   Math.max(ssRegression.r2, hleRegression.r2, fmcRegression.r2) === hleRegression.r2 ? "Healthy life expectancy" :
                                   "Freedom to make life choices";

            // Update paragraph with R² values and conclusion
            d3.select("#data-context")
                .html(`Data from the 2024 World Happiness Report, a global survey recognized by governments and organizations, assesses happiness through expert analysis in economics, psychology, and public policy. The dataset includes 140 countries with metrics like Ladder score (0-10 happiness scale), Social support, Healthy life expectancy, and Freedom to make life choices. Linear regression analysis shows Social support (R² = ${r2Values.ss}), Healthy life expectancy (R² = ${r2Values.hle}), and Freedom to make life choices (R² = ${r2Values.fmc}) correlate with Ladder score, with ${strongestFactor} showing the strongest correlation.`);

            // Initial scene
            updateScene(1, data);
        });
    </script>
</body>
</html>