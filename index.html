<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>World Happiness 2024 Narrative Visualization</title>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .container { margin: 20px auto; max-width: 800px; }
        .controls { margin-bottom: 20px; }
        .button { padding: 10px 20px; margin: 5px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
        .button:hover { background-color: #0056b3; }
        .tooltip { position: absolute; background-color: white; border: 1px solid black; padding: 5px; pointer-events: none; }
        .annotation-note-title { font-weight: bold; }
        .annotation-note-label { font-size: 12px; }
        .annotation-group { display: block !important; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Exploring 2024 World Happiness Factors</h1>
        <div class="controls">
            <button class="button" onclick="updateScene(1, data)">Scene 1: Social Support</button>
            <button class="button" onclick="updateScene(2, data)">Scene 2: Life Expectancy</button>
            <button class="button" onclick="updateScene(3, data)">Scene 3: Freedom</button>
        </div>
        <svg id="visualization" width="800" height="500"></svg>
    </div>
    <script>
        // Check if d3.annotation is available
        if (typeof d3.annotation === 'undefined') {
            console.error("d3-annotation library failed to load");
        }

        // Parameters
        const scenes = {
            1: {
                x: "Social support",
                y: "Ladder score",
                title: "Happiness vs Social Support",
                annotations: [
                    { note: { title: "High Social Support", label: "Finland: Strong community ties boost happiness" }, dy: -20, dx: 20, country: "Finland" },
                    { note: { title: "Low Social Support", label: "Afghanistan: Weak support lowers happiness" }, dy: 20, dx: -20, country: "Afghanistan" }
                ]
            },
            2: {
                x: "Healthy life expectancy",
                y: "Ladder score",
                title: "Happiness vs Healthy Life Expectancy",
                annotations: [
                    { note: { title: "High Life Expectancy", label: "Hong Kong: Long, healthy lives correlate with happiness" }, dy: -20, dx: 20, country: "Hong Kong S.A.R. of China" }
                ]
            },
            3: {
                x: "Freedom to make life choices",
                y: "Ladder score",
                title: "Happiness vs Freedom",
                annotations: [],
                interactive: true
            }
        };

        // SVG setup
        const svg = d3.select("#visualization");
        const margin = { top: 50, right: 50, bottom: 70, left: 70 };
        const width = svg.attr("width") - margin.left - margin.right;
        const height = svg.attr("height") - margin.top - margin.bottom;
        const g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Scales
        const xScale = d3.scaleLinear().range([0, width]);
        const yScale = d3.scaleLinear().range([height, 0]);
        const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

        // Axes
        const xAxis = g.append("g").attr("transform", "translate(0," + height + ")");
        const yAxis = g.append("g");

        // Tooltip
        const tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

        // Update scene function (global scope)
        function updateScene(sceneNumber, data) {
            const scene = scenes[sceneNumber];

            // Clear previous content
            g.selectAll(".dot, .annotation-group").remove();

            // Update scales
            xScale.domain(d3.extent(data, d => d[scene.x]) || [0, 1]).nice();
            yScale.domain(d3.extent(data, d => d[scene.y]) || [0, 1]).nice();

            // Update axes
            xAxis.transition().call(d3.axisBottom(xScale));
            yAxis.transition().call(d3.axisLeft(yScale));
            xAxis.selectAll("text").remove();
            xAxis.append("text")
                .attr("x", width / 2)
                .attr("y", 40)
                .attr("fill", "black")
                .text(scene.x);
            yAxis.selectAll("text").remove();
            yAxis.append("text")
                .attr("x", -height / 2)
                .attr("y", -40)
                .attr("transform", "rotate(-90)")
                .attr("fill", "black")
                .text(scene.y);

            // Title
            svg.selectAll(".title").remove();
            svg.append("text")
                .attr("class", "title")
                .attr("x", width / 2 + margin.left)
                .attr("y", margin.top / 2)
                .attr("text-anchor", "middle")
                .text(scene.title);

            // Draw dots
            g.selectAll(".dot")
                .data(data)
                .enter()
                .append("circle")
                .attr("class", "dot")
                .attr("cx", d => xScale(d[scene.x]))
                .attr("cy", d => yScale(d[scene.y]))
                .attr("r", 5)
                .attr("fill", (d, i) => colorScale(i % 10))
                .on("mouseover", function(d) {
                    tooltip.transition().style("opacity", 0.9);
                    tooltip.html(`Country: ${d["Country name"]}<br>Ladder score: ${d["Ladder score"]}<br>${scene.x}: ${d[scene.x]}`)
                        .style("left", (d3.event.pageX + 5) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.transition().style("opacity", 0);
                });

            // Annotations
            if (typeof d3.annotation !== 'undefined') {
                const annotations = scene.annotations
                    .map(ann => {
                        const countryData = data.find(d => d["Country name"] === ann.country);
                        if (!countryData) {
                            console.warn(`Annotation for ${ann.country} skipped: country not found or missing data`);
                            return null;
                        }
                        const xPos = countryData[scene.x];
                        const yPos = countryData[scene.y];
                        console.log(`Annotation for ${ann.country}: raw x=${xPos}, raw y=${yPos}, scaled x=${xScale(xPos)}, scaled y=${yScale(yPos)}`);
                        return {
                            note: ann.note,
                            dy: ann.dy,
                            dx: ann.dx,
                            x: xPos,
                            y: yPos
                        };
                    })
                    .filter(ann => ann !== null);

                if (annotations.length > 0) {
                    const makeAnnotations = d3.annotation()
                        .type(d3.annotationLabel)
                        .accessors({
                            x: d => xScale(d.x),
                            y: d => yScale(d.y)
                        })
                        .annotations(annotations);
                    const annotationGroup = g.append("g")
                        .attr("class", "annotation-group")
                        .call(makeAnnotations);
                    console.log("Annotation group created:", annotationGroup.nodes().length, "nodes");
                } else {
                    console.warn("No valid annotations to render");
                }
            } else {
                console.warn("Annotations skipped: d3-annotation library not loaded");
            }
        }

        // Load data and initialize
        let data = [];
        d3.csv("world-happiness-report-2024.csv", function(error, csvData) {
            if (error) {
                console.error("Error loading CSV:", error);
                return;
            }

            // Convert strings to numbers and filter out invalid rows
            data = csvData.filter(d => 
                d["Ladder score"] && 
                d["Social support"] && 
                d["Healthy life expectancy"] && 
                d["Freedom to make life choices"] &&
                !isNaN(+d["Ladder score"]) &&
                !isNaN(+d["Social support"]) &&
                !isNaN(+d["Healthy life expectancy"]) &&
                !isNaN(+d["Freedom to make life choices"])
            ).map(d => ({
                "Country name": d["Country name"],
                "Ladder score": +d["Ladder score"],
                "Social support": +d["Social support"],
                "Healthy life expectancy": +d["Healthy life expectancy"],
                "Freedom to make life choices": +d["Freedom to make life choices"]
            }));

            console.log("Processed data:", data);

            // Verify annotation countries exist
            const annotationCountries = ["Finland", "Afghanistan", "Hong Kong S.A.R. of China"];
            annotationCountries.forEach(country => {
                if (!data.find(d => d["Country name"] === country)) {
                    console.warn(`Country "${country}" not found in dataset`);
                }
            });

            // Initial scene
            updateScene(1, data);
        });
    </script>
</body>
</html>